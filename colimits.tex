\chapter{Colimits}
\label{chap:colim}

\epigraph{A comathematician is a device turning cotheorems into
  ffee.}{Mathematical folklore}

As seen in chapter~\ref{chap:hott}, adding sigma-types to type theory
results in adding limits over graphs in the underlying category, and
adding higher inductives typves results in adding colimits over
graphs. If limits has been extensively studied in~\cite{lumsdaine},
theory of colimits was not completely treated.

The following is conjoint work with Simon Boulier and Nicolas
Tabareau, helped by precious discussions with Egbert Rijke.
The sections~\ref{sec:colim} and~\ref{sec:floris} are extended version
of the blog post~\cite{boulier}.

\section{Colimits over graphs}
\label{sec:colim}

As colimits are just dual to limits, it seems that it would be very
easy to translate the work on limits to colimits. Althought, even if
it might be because we are more habituated to manipulate sigma-types
than higher inductive types, it seems way harder.

\subsection{Definitions}
\label{ssec:colim:defi}

Let's recall the definitions of graphs and diagrams over graphs,
introduced in~\cite{lumsdaine}.

\begin{defi}[Graph]\label{defi:graph}
  A {\em graph} $G$ is the data of
  \begin{itemize}
  \item a type $G_0$ of vertices ;
  \item for any $i,j:G_0$, a type $G_1(i,j)$ of edges.
  \end{itemize}
\end{defi}

\begin{defi}[Diagram]\label{defi:diagram}
  A {\em diagram} $D$ over a graph $G$ is the data of
  \begin{itemize}
  \item for any $i:G_0$, a type $D_0(i)$ ;
  \item for any $i,j:G_0$ and all $\phi : G_1(i,j)$, a map $D_1(\phi)
    : D_0(i) \to D_0(j)$
  \end{itemize}
\end{defi}

When the context is clear, $G_0$ will be simply denoted $G$,
$G_1(i,j)$ will be noted $G(i,j)$, $D_0(i)$
will be noted $D(i)$ or $D_i$, and $D_1(\phi)$ will be noted
$D_{i,j}(\phi)$ or simply $D(\phi)$ ($i$ and $j$ can be inferred from
$\phi$).

\begin{exms}
  \item One can consider the following graph, namely the graph of
    (co)equalizers
    \[ \xymatrix{\bullet \ar@<-.5ex>[r] \ar@<.5ex>[r] & \bullet} \]
    Here, $G_0 = \two$, $G_1(\True,\False) = \two$ and other
    $G_1(i,j)$ are empty.

    A diagram over this graph consists of two types $A$ and $B$, and
    two maps $f,g:A \to B$, producing the diagram
    \[ \xymatrix{A \ar@<-.5ex>[r]_g \ar@<.5ex>[r]^f & B} \]
  \item The graph of the mapping telescope is 
    \[ \xymatrix{ \bullet \ar[r] &\bullet \ar[r] &\cdots} \]
    In other words, $G_0=\N$ and $G_1(i,i+1) = \one$.

    A diagram over the mapping telescope is a sequence of types $P:\N
    \to \Type$ together with arrows $f_n:P_n \to P_{n+1}$:
    \[ \xymatrix{ P_0 \ar[r]^{f_0} & P_1 \ar[r]^{f_1} & \cdots} \]
\end{exms}

What we would like now would be to define the colimits of these
diagrams over graphs, that would satisfy type theoretic versions of
usual properties: it should make the diagram commute, and be universal
with respect to this property.
From now on, let $G$ be a graph and $D$ a diagram over this graph.

The commutation of the diagram is easy: the colimit should be the tip
of a cocone.

\begin{defi}[Cocone]\label{defi:cocone}
  Let $Q$ be a type. A cocone over $D$ intro $Q$ is the data of arrows
  $q_i:D_i \to Q$, and for any $i,j:G$ and $g:G(i,j)$, an homotopy 
  $q_j \circ D(g) \homot q_i$.
\end{defi}

If $Q$ and $Q'$ are type with an arrow $f:Q\to Q'$, and if $C$ is a
cocone over $D$ into $Q$, one can easily build a cocone on $D$ into
$Q'$ by postcomposing all maps of the cocone by $f$, giving a map
\newcommand{\postcomposecocone}{\mathrm{postcompose}_{\mathrm{cocone}}}
\[\postcomposecocone : \cocone_D(Q) \to (Q':\Type) \to (Q \to Q') \to \cocone_D(Q') \]
The other way around (from a cocone into $Q'$, give a map $Q\to Q'$)
is exactly the second condition we seek:

\begin{defi}[Universality of a cocone]
  Let $Q$ be a type, and $C$ be a cocone over $D$ into $Q$. $C$ is
  said universal if for any type $Q'$, $\postcomposecocone(C,Q')$ is
  an equivalence.
\end{defi}

We can finally define what it means for $Q$ to be a colimit of $D$.

\begin{defi}[Colimit]\label{defi:colimit}
  A type $Q$ is said to be a colimit of $D$ if there is a cocone $C$
  over $D$ into $Q$, which is universal.
\end{defi}

\begin{exm}
  Let $A$, $B$ be types and $f,g:A\to B$.
  Let $Q$ be the HIT generated by
  $\left|
  \begin{array}{lll}
    q & : & B \to Q \\
    \alpha & : & q \circ f \homot q \circ g
  \end{array} \right. .$
Then $Q$ is a colimit of the coequalizer diagram associated to
$A,B,f,g$. We say that $Q$ is a coequalizer of $f$ and $g$.
\end{exm}

Note that for any diagram $D$, one can build a free colimit of $D$,
namely the higher inductive type $\colim(D)$ generated by
\[ 
  \left|
    \begin{array}{lll}
      \colim & : & \prodD i G {D_i \to \colim(D)} \\
      \alpha_\colim & : & \prodD {i j} G {\prodD g {G(i,j)} {\prodD x
                          {D_i} {\colim_j \circ D(g) \homot \colim_i}}}
    \end{array} \right.
\]


\todo[inline]{Finish colimits}
\subsection{Properties of colimits}
\label{ssec:prop_colim}

\subsection{Truncated colimits}
\label{ssec:trunc_colim}

As said in\todo[fancyline]{Insert here a relevent ref}, we now give a
truncated version of colimits. 
Colimits actually behave well with respect to truncations. Indeed, if $D$ is a
diagram and $P$ a colimit of $D$, then $\|P\|_n$ is the $n$-colimit
of the $n$-truncated diagram $\|D\|_n$. Let's make it more precise.

\begin{defi}[Truncation of a diagram]
  Let $D$ be a diagram over a graph $G$, and $n$ a truncation index.
  Then the diagram $\|D\|_n$ is the diagram over $G$ defined by
  \begin{itemize}
  \item $(\|D\|_n)_0(i) \defeq \|D_0(i)\|_n:\Type_n$
  \item $(\|D\|_n)_1(\phi) \defeq |D_1(\phi)|_n : \|D_0(i)\|_n \to \|D_0(j)\|_n$
  \end{itemize}
\end{defi}

\begin{defi}
  Let $D$ be a diagram over a graph $G$, $P$ be a type, and $C$ a
  cocone over $D$ into $P$. $C$ is said $n$-universal if for any
  $Q:\Type_n$, $\postcompose_{\mathrm{cocone}}(C,Q)$ is an
  equivalence.

  Then, $P$ is said to be a $n$-colimit of $D$ if there is a cocone
  $C$ over $D$ into $Q$ which is $n$-universal.
\end{defi}

We can now give the fundamental proposition linking colimit and
$n$-colimit.

\begin{prop}
  Let $D$ be a diagram, and $P:\Type$.
  Then, if $P$ is a colimit of $D$, $\|P\|_n$ is a $n$-colimit of $\|D\|_n$.
\end{prop}

The proof of this is really straightforward: a cocone over $D$ into
$P$ can be changed equivalently into a cocone over $\|D\|_n$ into $\|P\|_n$, using the
elimination principle~\ref{lem:trunc_elim} of truncations, and then
we can show that the following diagram commutes for any $X:\Type_n$
\[
  \xymatrix{
    \|P\|_n \to X \ar[r] \ar[d]^*[@]{\hbox to 0pt{\hss$\sim$\hss}} & \mathrm{cocone}(\|D\|_n,X) \\
    P \to X \ar[r]^\sim& \mathrm{cocone}(D,X) \ar[u]^*[@]{\hbox to 0pt{\hss$\sim$\hss}}
  }
\]

\begin{rmq}
This result does not hold for limits. If it were
true, then applying it to the following equalizer diagram
\[ \xymatrix{ A \ar@<-.5ex>[r]_{\lambda \_,\,y} \ar@<.5ex>[r]^f & B }\]
with $A,B:\Type$, $f:A\to B$ and $y:B$ would lead to an equivalence
\[ \left\| \sumD a A {f a = y} \right\|_{n} \simeq \sumD a {\|A\|_{n}}
  {|f|_{n}\, a = |y|_{n}}, \]
proving left-exactness of $n$-truncation.  
\end{rmq}

\subsection{Towards highly coherent colimits}
\label{ssec:high_colimit}

\section{Van Doorn's and Boulier's constructions}
\label{sec:floris}

In topos theory, there is a result that we would want to use in
chapter~\ref{chap:sheaf}:
\begin{lem}[{\cite[IV.7.8]{maclanemoerdijk}}]
  In a topos $\mathcal E$, if $f\in\Hom{\mathcal E}(A,B)$ is an epimorphism, then the colimit
  of
  \[ \xymatrix{ A\times_B A \ar@<-.5ex>[r]_-{\pi_2}
      \ar@<.5ex>[r]^-{\pi_1} & A }\]
  is $B$. The pullback $A\times_B A$ is called the kernel pair of $f$.
  
\end{lem}
Unfortunately, this result fails in higher topos ; the kernel pair
should be replaced by the \v{C}ech nerve of $f$.
\[
  \xymatrix{
    \dots \ar@<-1ex>[r]\ar@<-.33ex>[r]\ar@<.33ex>[r]\ar@<1ex>[r] & A\times_B A\times_B A \ar@<-.7ex>[r] \ar[r] \ar@<.7ex>[r]
    & A\times_B A \ar@<-.5ex>[r] \ar@<.5ex>[r] & A \ar[r]^f_{\colim}& B
  }
\]
The issue we face in homotopy type theory is that the definition of
the \v{C}ech nerve, and in general of simplicial objects is a hard
open problem. It involves an infinite tower of coherences, and we
do not know how to handle this. However, there is a way to define a
diagram depending on a map $f$, which colimit is $\im(f)$.

The starting point of the construction is Floris Van Doorn's
construction of proposition truncation~\cite{floris}. 

\begin{prop}[Van Doorn's construction]\label{prop:floris}
  Let $A:\Type$. We define the higher inductive type $TA$ as the
  coequalizer of
  \[ \xymatrix{ A\times A \ar@<-.5ex>[r]_-{\pi_2}
      \ar@<.5ex>[r]^-{\pi_1} & A }.\]
  The colimit of the diagram
  \[ \xymatrix{
      A \ar[r]^-q& TA \ar[r]^-q& TTA \ar[r]^-q& TTTA \ar[r]^-q& \dots
    }\]
  is $\|A\|_{-1}$.
\end{prop}
Let's compare the direct definitions of $\|A\|_{-1}$ and $TA$
\[
  \|A\|_{-1} \left|
    \begin{array}{lll}
      \tr &:& A\to\|A\|_{-1} \\
      \alpha_{\tr} &:& \prodD {x,y}{\|A\|_{-1}}{x=y}
    \end{array}
  \right.
  \qquad
  TA \left|
    \begin{array}{lll}
      q &:& A\to TA \\
      \alpha &:& \prodD {x,y}{A}{q\, x=q\, y}
    \end{array}
  \right.
\]
The definitions are almost the same, except that the path constructor
of $TA$ quantifies over $A$, while the one of $\|A\|_{-1}$ quantifies
over $\|A\|_{-1}$ itself: such a higher inductive type is a {\em
  recursive} inductive type. Thus, proposition~\ref{prop:floris}
allows us to build the truncation in a non-recursive way. The
counterpart is that we have to iterate the
construction. In~\cite{boulier}, we found a way to generalise a bit
this result. The main idea is that iterating the kernel pair
construction will result in a diagram of colimit $\im(f)$.

Now, let $A,B:\Type$ and $f:A\to B$. We define the kernel pair of $f$
as the coequalizer of \[ \xymatrix{ A\times_B A \ar@<-.5ex>[r]_-{\pi_2}
      \ar@<.5ex>[r]^-{\pi_1} & A }.\]
In other words, $\KP(f)$ is the higher inductive type generated by
\[\left|
    \begin{array}{lll}
      \kp &:& A\to \KP(f) \\
      \alpha &:& \displaystyle{\prodD {x,y}{A}{f\, x = f\, y \to kp\,x=\kp\,y}}
    \end{array}
  \right.\]
Using the eliminator of coequalizers, one can build a map $\widehat
f:\KP(f) \to B$, such that the following commutes
\[\xymatrix{
    A \ar[r]^-{\kp} \ar[rd]_-f & \KP(f) \ar[d]^-{\widehat f} \\
    &B
}\]
Then we can build $KP(\widehat f)$ and build a map $\widehat{\widehat
  f}:\KP(\widehat f) \to B$, \etc{}
We have the following result
\begin{prop}[Boulier's construction]\label{prop:cech'}
  For any $f:A\to B$, $\im(f)$ is the colimit of the iterated kernel
  pair diagram of $f$
\[\xymatrix{
  A \ar[r] & \KP(f) \ar[r] & \KP\left(\widehat f\right) \ar[r]& \KP\left(\widehat{\widehat f}\right) \ar[r]& \cdots
}\]
In particular, if $f$ is a surjection, the colimit of this diagram is $B$.
\end{prop}
\begin{proof}
  The main idea of the proof is the equivalence between the diagrams
\[
\xymatrix{
  A \ar[r] & \KP(f) \ar[r] & \KP\left(\widehat f\right) \ar[r]&
  \cdots & \\
  \displaystyle{\sumD y B {\fib f y}} \ar[r] & \displaystyle{\sumD y B {T(\fib f y)}} \ar[r]& \displaystyle{\sumD
  y B {TT(\fib f y)}} \ar[r]&  \cdots &
}
\]

Let's begin by showing the first non-trivial equivalence: 
\begin{equation}
  \label{eq:KP}
  s: \KP(f) \simeq \sumD y B {T(\fib f y)}.  
\end{equation}

$\KP(f)$ is the colimit of $\xymatrix{ A\times_B A \ar@<-.5ex>[r]_-{\pi_2}
  \ar@<.5ex>[r]^-{\pi_1} & A }$, and $\sumD y B {T(\fib f y)}$ is
the colimit of $\xymatrix{ \sumD y B {\fib f y \times \fib f y} \ar@<-.5ex>[r]
  \ar@<.5ex>[r] & \sumD y B {\fib f y} }$.
As the two diagrams are equivalent, their colimits are equivalent. We
will need the following fact, easily checked
\[ \pi_1 \circ s = \widehat f.\]

Now, let's prove the other equivalences. We need the following lemma
\begin{lem}
  Let $X,Y:\Type$ and $\varphi:X\to Y$. Then $\fib{\widehat\varphi}y
  \simeq T(\fib\varphi y)$.
\end{lem}
\begin{prooflem}
  We have the following sequence of equivalences:
  \begin{align*}
    \fib{\widehat\varphi}y 
    &\defeq \sumD x {\KP(\varphi)}{\widehat \varphi\, x = y} \\
    &\simeq \sumD x {\sumD y B {T(\fib \varphi y)}} {\widehat \varphi \circ s^{-1}
      (x) = y} \quad\text{by \ref{eq:KP}} \\
    &\simeq\sumD x {\sumD y B {T(\fib \varphi y)}} {\pi_1(x) = y} \\
    &\simeq T(\fib \varphi y)
  \end{align*}
\end{prooflem}
Then, using the sum-of-fibers property, we can change the iterated
kernel pair of $f$ into
\[
\xymatrix{
\displaystyle{\sumD y B {\fib f y}} \ar[r] & \displaystyle{\sumD y B
  {\fib{\widehat f}y}} \ar[r]& \displaystyle{\sumD
  y B {\fib{\widehat{\widehat f}} y}} \ar[r]&  \cdots &
}
\]
With the just proved lemma, and a bit of induction, we can prove the
desired equivalence of diagrams.

As colimits are stable under dependent sum, we know that the colimit
of the diagram is thus $\sumD y B {Q\, y}$, where $Q$ is the colimit
of
\[\xymatrix{\displaystyle{{\fib f y}} \ar[r] & \displaystyle{{T(\fib f
        y)}} \ar[r]& \displaystyle{{TT(\fib f y)}} \ar[r]&  \cdots
    &}\]
But proposition~\ref{prop:floris} asserts that $Q \simeq \|\fib f
y\|_{-1}$, and the result is proved.
\end{proof}

The main issue with Van Doorn's construction is
that is does not preserve truncations levels at all. For example, when
computing $\|\one\|_{-1}$, the first step is $T\one \simeq \Sone$,
which is a $1$-type. 
Asking for preservation of all truncation levels along the diagram
might be too much, but the least we could ask is that when starting
with a $P:\HProp$, the diagram should be the constant diagram $P\to
P \to P\to \cdots$. The Boulier counterpart of this is, when starting
with an embedding $f$, all $\widehat f$ are embeddings. 

This can be achieve by changing operators $T$ and $\KP$, by asking
them to preserve identities:
\[
  TA~\left|
    \begin{array}{lll}
      q&:& A\to TA \\
      \alpha&:& \displaystyle{\prodD {x,y} A {q\, x = q\, y}} \\
      \alpha_1&:& \displaystyle{\prodD x A {\alpha(x,x) = 1}}
    \end{array}
  \right.
  \quad ; \quad
  \KP(f)~\left|
    \begin{array}{lll}
      \kp&:&A\to \KP(f) \\
      \alpha&:& \displaystyle{\prodD {x,y} A {f\, x = f\, y \to q\, x = q\, y}} \\
      \alpha_1&:& \displaystyle{\prodD x A {\alpha(x,x,1) = 1}}
    \end{array}    
  \right.
\]
Then, the following is still true

\begin{prop}[Boulier's construction]\label{prop:cech}
  For any $f:A\to B$, $\im(f)$ is the colimit of the iterated kernel
  pair diagram of $f$
\[\xymatrix{
  A \ar[r] & \KP(f) \ar[r] & \KP\left(\widehat f\right) \ar[r]& \KP\left(\widehat{\widehat f}\right) \ar[r]& \cdots
}\]
Moreover, if $f$ is an embedding, $\widehat f$ also is.
\end{prop}
The proof is almost the same as for proposition~\ref{prop:cech'},
except that the new constructors in the higher inductives types
introduce another level of coherence, which is very technical to handle.

\section{Towards groupoid objects}
\label{sec:groupoid}